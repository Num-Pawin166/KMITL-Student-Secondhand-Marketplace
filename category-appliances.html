<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หมวดหมู่ - เครื่องใช้ไฟฟ้า</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    
    <div class="container">
        <header>
            <a href="index.html" class="logo-link" style="font-weight: bold; font-size: 1.2rem;">KMITL Marketplace</a>
            <div class="search-bar">
                <input type="text" placeholder="Search for products...">
            </div>
            <a href="add-product.html" class="post-item-btn"><i class="fas fa-plus-circle"></i> ลงขายสินค้า</a>
            <div class="header-icons">
                <a href="Cart.html" class="icon-link"><i class="fas fa-shopping-cart"></i></a>
                <a href="dashboard.html" class="icon-link"><i class="fas fa-user"></i></a>
            </div>
        </header>
        
        <main>
            <div class="category-header">
                <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> กลับไปหน้าแรก</a>
                <h1><i class="fas fa-plug"></i> หมวดหมู่: เครื่องใช้ไฟฟ้า</h1>
            </div>
            <div class="product-grid" id="product-grid-appliances">
                </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const productGrid = document.getElementById('product-grid-appliances');
            const categoryName = 'appliances'; // <-- ชื่อหมวดหมู่สำหรับหน้านี้

            // --- 1. เพิ่มโค้ดจัดการตะกร้า (Cart Manager) ---
            const cartManager = {
                getCart: function() {
                    return JSON.parse(localStorage.getItem('shoppingCart')) || [];
                },
                saveCart: function(cart) {
                    localStorage.setItem('shoppingCart', JSON.stringify(cart));
                },
                addItem: function(product) {
                    const cart = this.getCart();
                    const existingItem = cart.find(item => item.id === product.id);
                    if (existingItem) {
                        existingItem.quantity += 1;
                    } else {
                        product.quantity = 1;
                        cart.push(product);
                    }
                    this.saveCart(cart);
                    alert(`เพิ่ม '${product.name}' ลงในตะกร้าแล้ว!`);
                }
            };

            // --- 2. ดึงข้อมูลสินค้าตามหมวดหมู่ (เหมือนเดิม) ---
            try {
                const response = await fetch(`/api/products/category/${categoryName}`);
                if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลสินค้าได้');
                
                const products = await response.json();
                productGrid.innerHTML = '';

                if (products.length === 0) {
                    productGrid.innerHTML = `<p style="text-align: center; width: 100%;">ไม่พบสินค้าในหมวดหมู่นี้</p>`;
                    return;
                }

                // --- 3. แก้ไขการสร้างการ์ดสินค้าให้มีปุ่ม "เพิ่มลงตะกร้า" ---
                products.forEach(product => {
                    const productCard = document.createElement('div'); // เปลี่ยนจาก <a> เป็น <div>
                    productCard.className = 'product-card';

                    const imageUrl = product.image_urls && product.image_urls.length > 0
                        ? `/${product.image_urls[0]}`
                        : 'https://via.placeholder.com/250';

                    productCard.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}">
                        <div class="product-card-info">
                            <h3>${product.name}</h3>
                            <p>${product.price.toLocaleString()} B</p>
                            <button class="add-to-cart-btn">เพิ่มลงตะกร้า</button>
                        </div>
                    `;

                    // --- 4. เพิ่ม Event Listener ให้กับปุ่มที่สร้างขึ้นใหม่ ---
                    const addToCartButton = productCard.querySelector('.add-to-cart-btn');
                    addToCartButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // ป้องกัน event bubbling
                        const productToAdd = {
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            image: imageUrl
                        };
                        cartManager.addItem(productToAdd);
                    });

                    productGrid.appendChild(productCard);
                });

            } catch (error) {
                console.error(`Error fetching products for category '${categoryName}':`, error);
                productGrid.innerHTML = '<p>เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้า</p>';
            }
        });
    </script>
</body>
</html>