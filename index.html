<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMITL Student Secondhand Marketplace</title>
    
    <script src="auth.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <div class="container">
        <header>
            <a href="index.html" class="logo-link" style="font-weight: bold; font-size: 1.2rem;">KMITL Marketplace</a>
            <div class="search-bar">
                <input type="text" placeholder="Search for products...">
            </div>
            <a href="add-product.html" class="post-item-btn"><i class="fas fa-plus-circle"></i> ลงขายสินค้า</a>
            
            <div class="header-icons" id="header-auth-section">
                </div>
        </header>

        <main>
            <section class="hero">
                <h1>KMITL Student <br> Secondhand Marketplace</h1>
                <div class="hero-diamond"></div>
                <p>พื้นที่กลางสำหรับนักศึกษาโพสต์ขาย/ค้นหาสินค้ามือสองในรั้วมหาวิทยาลัย เพื่อความสะดวก ปลอดภัย และลดของเสีย</p>
                <button class="hero-button">ซื้อเลย !!!</button>
            </section>
        </main>
    </div>

    <div class="banner"></div>

    <div class="container">
        <section class="category-section">
            <h2>หมวดหมู่</h2>
            <div class="category-grid">
                <a href="category-clothing.html" class="category-card"><h3>เสื้อผ้า</h3><img src="images/1.jpg" alt="เสื้อผ้า"></a>
                <a href="category-appliances.html" class="category-card"><h3>เครื่องใช้ไฟฟ้า</h3><img src="images/2.jpg" alt="เครื่องใช้ไฟฟ้า"></a>
                <a href="category-home.html" class="category-card"><h3>บ้านและสวน</h3><img src="images/4.jpg" alt="บ้านและสวน"></a>
                <a href="category-health.html" class="category-card"><h3>สุขภาพและความงาม</h3><img src="images/3.png" alt="สุขภาพและความงาม"></a>
            </div>
        </section>
    </div>

    <div class="container">
        <section class="products-section">
            <h2>สินค้าใหม่</h2>
            <div class="product-grid" id="new-products-grid">
                </div>
            <div class="view-more-container">
                <button class="view-more-btn button-style">เพิ่มเติม</button>
            </div>
        </section>

        <section class="products-section">
            <h2>อื่นๆ</h2>
            <div class="product-grid">
                </div>
            <div class="view-more-container">
                <button class="view-more-btn button-style">เพิ่มเติม</button>
            </div>
        </section>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- ฟังก์ชันสำหรับอัปเดต Header ตามสถานะการล็อกอิน ---
            const updateHeader = async () => {
                const headerAuthSection = document.getElementById('header-auth-section');
                try {
                    const response = await fetch('http://127.0.0.1:5000/api/check-auth', {
                        method: 'GET',
                        credentials: 'include' // สำคัญ: เพื่อส่ง Cookie ไปกับ Request
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // ถ้าล็อกอินแล้ว: แสดงชื่อผู้ใช้และปุ่มต่างๆ
                        headerAuthSection.innerHTML = `
                            <span class="welcome-user">ยินดีต้อนรับ, ${data.user.username}</span>
                            <a href="#" class="icon-link" id="logout-btn" title="ออกจากระบบ"><i class="fas fa-sign-out-alt"></i></a>
                            <a href="Cart.html" class="icon-link" title="ตะกร้าสินค้า"><i class="fas fa-shopping-cart"></i></a>
                            <a href="dashboard.html" class="icon-link" title="แดชบอร์ด"><i class="fas fa-user"></i></a>
                        `;

                        // เพิ่ม Event Listener ให้ปุ่ม Logout
                        document.getElementById('logout-btn').addEventListener('click', async (e) => {
                            e.preventDefault();
                            await fetch('http://127.0.0.1:5000/api/logout', {
                                method: 'POST',
                                credentials: 'include'
                            });
                            alert('ออกจากระบบสำเร็จ');
                            window.location.href = 'User-Login.html';
                        });

                    } else {
                        // ถ้ายังไม่ล็อกอิน: แสดงปุ่มเข้าสู่ระบบ
                        headerAuthSection.innerHTML = `
                             <a href="User-Login.html" class="post-item-btn">เข้าสู่ระบบ / สมัครสมาชิก</a>
                        `;
                    }
                } catch (error) {
                    console.error('Failed to update header:', error);
                    // ถ้าเกิดข้อผิดพลาด (เช่น Backend ปิด) ให้แสดงปุ่มเข้าสู่ระบบไว้ก่อน
                    headerAuthSection.innerHTML = `
                        <a href="User-Login.html" class="post-item-btn">เข้าสู่ระบบ / สมัครสมาชิก</a>
                    `;
                }
            };

        // --- ฟังก์ชันสำหรับจัดการตะกร้าสินค้าใน localStorage ---
        const cartManager = {
            getCart: function() {
                // ดึงข้อมูลตะกร้าจาก localStorage, ถ้าไม่มีให้คืนค่าเป็น array ว่าง
                return JSON.parse(localStorage.getItem('shoppingCart')) || [];
            },
            saveCart: function(cart) {
                // บันทึกข้อมูลตะกร้ากลับลงไปใน localStorage
                localStorage.setItem('shoppingCart', JSON.stringify(cart));
            },
            addItem: function(product) {
                const cart = this.getCart();
                // ตรวจสอบว่ามีสินค้านี้ในตะกร้าหรือยัง
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) {
                    // ถ้ามีแล้ว ให้เพิ่มจำนวน
                    existingItem.quantity += 1;
                } else {
                    // ถ้ายังไม่มี ให้เพิ่มเข้าไปใหม่
                    product.quantity = 1;
                    cart.push(product);
                }
                this.saveCart(cart);
                alert(`เพิ่ม '${product.name}' ลงในตะกร้าแล้ว!`);
            }
        };

        // --- ฟังก์ชันสำหรับดึงข้อมูลสินค้าใหม่ ---
        const fetchNewProducts = async () => {
            const newProductsGrid = document.getElementById('new-products-grid');
            try {
                const response = await fetch('http://127.0.0.1:5000/api/products');
                if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลสินค้าได้');
                
                const allProducts = await response.json();
                newProductsGrid.innerHTML = '';

                allProducts.forEach(product => {
                    const productCard = document.createElement('div'); // เปลี่ยนจาก <a> เป็น <div>
                    productCard.className = 'product-card';
                    
                    const imageUrl = product.image_urls && product.image_urls.length > 0
                        ? `http://127.0.0.1:5000/${product.image_urls[0]}`
                        : 'https://via.placeholder.com/250';

                    productCard.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}">
                        <div class="product-card-info">
                            <h3>${product.name}</h3>
                            <p>${product.price.toLocaleString()} B</p>
                            <!-- ▼▼▼ เพิ่มปุ่ม "เพิ่มลงตะกร้า" ▼▼▼ -->
                            <button class="add-to-cart-btn">เพิ่มลงตะกร้า</button>
                        </div>`;
                    
                    productCard.innerHTML = `
                        <img src="${imageUrl}" alt="${product.name}">
                        <div class="product-card-info">
                            <h3>${product.name}</h3>
                            <p>${product.price.toLocaleString()} B</p>
                            <button class="add-to-cart-btn">เพิ่มลงตะกร้า</button>
                            <a href="chat.html?product_id=${product.id}&seller_id=${product.owner_id}" class="contact-seller-btn">
                                ติดต่อผู้ขาย
                            </a>
                        </div>`;

                    // --- เพิ่ม Event Listener ให้ปุ่ม ---
                    const addToCartButton = productCard.querySelector('.add-to-cart-btn');
                    addToCartButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // หยุดไม่ให้ event bubbling
                        // สร้าง object ของสินค้าที่จะเพิ่มลงตะกร้า
                        const productToAdd = {
                            id: product.id,
                            name: product.name,
                            price: product.price,
                            image: imageUrl
                        };
                        cartManager.addItem(productToAdd);
                    });

                    newProductsGrid.appendChild(productCard);
                });
            } catch (error) {
                console.error('Error fetching new products:', error);
            }
        };

            // เรียกใช้งานทั้งสองฟังก์ชันเมื่อหน้าเว็บโหลดเสร็จ
            updateHeader();
            fetchNewProducts();
        });
    </script>
</body>
</html>